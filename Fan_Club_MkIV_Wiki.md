# Fan Club MkIV 项目 Wiki 文档

## 项目概述

Fan Club MkIV 是加州理工学院研究生航空实验室（GALCIT）自主系统与技术中心开发的分布式风扇阵列控制系统。该系统采用主从架构，通过以太网实现对多个风扇模块的精确控制和监控。

### 项目结构
```
fan-club-master/
├── master/                 # 主控端代码
│   ├── main.py             # 程序入口
│   ├── fc/                 # 核心功能模块
│   │   ├── frontend/       # 前端GUI
│   │   ├── backend/        # 后端通信
│   │   └── archive.py      # 配置管理
│   └── profiles/           # 配置文件
├── slave/                  # 从机端代码（C++/Mbed OS）
│   ├── main.cpp           # 从机主程序
│   ├── Communicator.h/cpp # 通信模块
│   ├── Fan.h/cpp          # 风扇控制
│   └── Processor.h/cpp    # 命令处理
└── slave_bootloader/       # 引导加载程序
    ├── main.cpp           # 引导程序主文件
    ├── BTUtils.h          # 引导工具
    └── BTFlash.h          # 固件烧录
```

## 系统架构

### 1. 主从通信架构

```
主控端 (Python)          从机端 (C++/Mbed OS)
┌─────────────────┐      ┌─────────────────┐
│   GUI Frontend  │      │   Fan Control   │
├─────────────────┤      ├─────────────────┤
│ FCCommunicator  │<────>│  Communicator   │
├─────────────────┤      ├─────────────────┤
│   Network       │      │   Processor     │
│   Management    │      │   & Hardware    │
└─────────────────┘      └─────────────────┘
        │                         │
        └─────── Ethernet ────────┘
```

### 2. 数据流管道

根据 `standards.py` 中定义的通信标准：

```
控制管道: [控制向量 (占空比分配)] ────────────>
命令管道: [命令向量 (ADD, REBOOT, FIRMW...)] ──>
                                              ┌──────────┐
前端 ◄─── [反馈向量 F (占空比和转速)] ◄─────── │  后端    │
     ◄─── [从机向量 S (从机状态...)] ◄─────── │          │
     ◄─── [网络向量 N (全局IP和端口)] ◄─────── └──────────┘
     ◄─── [打印消息] ◄─────────────────────────
```

## 核心模块详解

### 1. 主控端 (master/)

#### 1.1 程序入口 (`main.py`)
- **功能**: 系统启动和初始化
- **关键组件**:
  - 配置文件加载
  - GUI窗口创建
  - 后端通信初始化
  - 多进程管理

#### 1.2 前端GUI (`fc/frontend/`)

##### 基础窗口 (`base.py`)
- **功能**: Tkinter主窗口框架
- **组件**:
  - 菜单栏管理
  - 状态栏显示
  - 窗口布局控制
  - 事件处理机制

##### 控制界面 (`widgets/control.py`)
- **功能**: 风扇阵列控制面板
- **特性**:
  - 实时反馈显示
  - 占空比控制
  - 转速监控
  - 网格映射显示
- **关键类**:
  - `ControlWidget`: 主控制容器
  - `ControlPanelWidget`: 控制面板

##### 网络管理 (`widgets/network.py`)
- **功能**: 网络连接和从机管理
- **特性**:
  - 网络连接控制
  - 从机状态监控
  - 固件更新管理
  - IP地址配置
- **关键类**:
  - `NetworkWidget`: 网络管理容器
  - `NetworkControlWidget`: 网络控制
  - `SlaveListWidget`: 从机列表
  - `FirmwareUpdateWidget`: 固件更新

#### 1.3 后端通信 (`fc/backend/`)

##### 主通信器 (`FCCommunicator.py`)
- **功能**: 与从机的UDP通信管理
- **核心方法**:
  - `getNewSlaves()`: 发现新从机
  - `add()`: 添加从机
  - `sendReboot()`: 重启从机
  - `sendDisconnect()`: 断开从机
  - `setSlaveStatus()`: 设置从机状态
  - `getSlaveStateVector()`: 获取从机状态
  - `stop()`: 停止通信

##### 映射器 (`mapper.py`)
- **功能**: 网络坐标与网格坐标的双向映射
- **核心类**: `Mapper`
- **映射关系**:
  - K坐标: (s, f) - 从机索引s，风扇索引f
  - G坐标: (l, r, c) - 层l，行r，列c
- **关键方法**:
  - `index_KG(k)`: K索引转G索引
  - `index_GK(g)`: G索引转K索引
  - `tuple_KG(s, f)`: K元组转G元组
  - `tuple_GK(l, r, c)`: G元组转K元组

#### 1.4 配置管理 (`archive.py`)
- **功能**: 配置文件管理和验证
- **参数类别**:
  - 核心参数: 名称、描述
  - 运行时参数: 平台、版本
  - 网络参数: IP、端口、超时设置
  - 从机参数: MAC地址、风扇配置
  - 阵列参数: 行列层数、最大转速

##### 内置配置 (`profiles.py`)
- **预定义配置**:
  - CAST风洞配置
  - JPL实验室配置
  - S117配置
  - 基础配置

#### 1.5 标准定义 (`standards.py`)
- **通信协议定义**:
  - 命令代码: `CMD_ADD`, `CMD_REBOOT`, `CMD_SHUTDOWN`等
  - 目标代码: `TGT_ALL`, `TGT_SELECTED`
  - 广播模式: `BMODE_BROADCAST`, `BMODE_TARGETTED`
  - 控制向量格式
  - 反馈向量格式

#### 1.6 工具函数 (`utils.py`)
- **平台检测**: Windows, macOS, Linux
- **调试工具**: 行号打印、错误追踪

### 2. 从机端 (slave/)

#### 2.1 主程序 (`main.cpp`)
- **版本**: Fanclub Mark II "B06271"
- **功能**:
  - 网络初始化
  - 配置信息打印
  - 主循环线程启动
  - 内存使用监控

#### 2.2 通信模块 (`Communicator.h/cpp`)
- **功能**: 与主控端的以太网通信
- **网络状态**:
  - `NO_NETWORK`: 无网络连接
  - `NO_MASTER`: 无主控连接
  - `CONNECTED`: 已连接
- **LED控制状态**:
  - `L_ON`: LED开启
  - `L_OFF`: LED关闭
  - `L_TOGGLE`: LED切换
- **线程管理**:
  - MISO线程: 发送数据到主控
  - MOSI线程: 接收主控命令
  - Listener线程: 监听广播

#### 2.3 风扇控制 (`Fan.h/cpp`)
- **功能**: PWM输出控制和转速读取
- **支持版本**:
  - vCT1, v2_9, v2_8, v2_8J, v2_7
- **引脚配置**: 不同版本的风扇引脚映射
- **最大风扇数**: 各版本支持的最大风扇数量

#### 2.4 处理器 (`Processor.h/cpp`)
- **功能**: 处理主控命令
- **支持命令**:
  - `WRITE`: 设置风扇占空比
  - `MULTI`: 多风扇控制
  - `CHASE`: 风扇转速追踪
- **特性**:
  - 线程管理
  - 缓冲区处理
  - 状态设置

#### 2.5 配置文件 (`settings.h`)
- **全局设置**:
  - 串口波特率
  - 堆栈大小
  - 风扇数量
  - LED闪烁周期
  - 通信端口配置
  - 超时设置
  - 最大消息长度

#### 2.6 编译配置 (`mbed_app.json`)
- **目标板**: NUCLEO_F429ZI
- **引导程序镜像路径配置
- **网络接口**: 以太网
- **Wi-Fi设置**: SSID和密码
- **SD卡SPI引脚配置

### 3. 引导加载程序 (slave_bootloader/)

#### 3.1 主程序 (`main.cpp`)
- **功能**: 固件更新和系统引导
- **网络设置**:
  - 波特率: `BAUDRATE`
  - 套接字超时: `SOCKET_TIMEOUT_MS`
  - 监听端口: `LISTENER_PORT`
- **命令标识符**:
  - `STD_BCAST`: 标准广播
  - `UPDATE_COMMAND`: 更新命令
  - `SHUTDOWN_COMMAND`: 关机命令
- **特性**:
  - 网络初始化
  - 广播监听
  - 固件更新处理
  - 错误处理和连接监控

#### 3.2 引导工具 (`BTUtils.h`)
- **LED控制**:
  - `setLED()`: 设置LED状态
  - `blinkMID()`: LED闪烁
- **系统控制**:
  - `reboot()`: 系统重启
  - `fatal()`: 致命错误处理
  - `launch()`: 应用程序启动

#### 3.3 固件烧录 (`BTFlash.h`)
- **烧录功能**:
  - `flash()`: 固件烧录
  - `copy()`: 固件复制
- **操作**:
  - 闪存页面擦除
  - 闪存页面编程
  - 烧录错误处理

## 通信协议

### 1. 控制向量格式
```
[CTL_DC_SINGLE, TGT_SELECTED, DC, TARGET_0, SEL_0, TARGET_1, SEL_1...]
 │              │             │   │           │     │           │
 │              │             │   │           │     │           第二个目标数据...
 │              │             │   │           │     第一个目标的风扇选择
 │              │             │   │           第一个目标从机索引
 │              │             │   目标占空比（整数，需要归一化）
 │              │             应用到选定的从机
 │              控制代码
 └── 占空比控制命令
```

### 2. 命令向量格式
```
[CODE, TARGET_CODE, TARGET_0, TARGET_1,...]
 │     │            │
 │     │            选定从机的索引（如适用）
 │     是否应用到所有从机或从机子集
 └── 命令代码：ADD、DISCONNECT、REBOOT等
```

### 3. 反馈向量格式
- 包含占空比和转速数据
- 实时从机状态信息
- 错误和警告信息

## 硬件支持

### 1. 支持的开发板
- **主要目标**: NUCLEO F429ZI
- **处理器**: STM32F429ZI
- **网络**: 以太网接口
- **存储**: 闪存和SD卡支持

### 2. 风扇控制版本
- **vCT1**: 最新版本
- **v2_9**: 版本2.9
- **v2_8**: 版本2.8
- **v2_8J**: 版本2.8J
- **v2_7**: 版本2.7

### 3. 引脚配置
不同版本具有不同的风扇引脚映射和最大风扇数量限制。

## 开发和维护

### 1. 编译环境
- **ARM GCC Tools**: 7.3.1 / 7.2.1
- **Mbed CLI**: 1.7.5
- **平台**: Windows, macOS, Linux

### 2. 依赖库
- **Python端**:
  - tkinter (GUI)
  - multiprocessing (多进程)
  - socket (网络通信)
- **C++端**:
  - Mbed OS
  - LWIP (网络协议栈)
  - FastPWM (PWM控制)

### 3. 测试框架
- **现有测试**: `fc/tests.py` (已过时)
- **建议改进**:
  - 更新测试框架
  - 自动化测试
  - 模拟从机测试
  - 压力测试
  - 网络故障测试

### 4. 调试工具
- **日志分析**: 多级别日志输出
- **外部控制器测试**: `mkiv_ec.py`
- **MATLAB接口**: 外部控制支持
- **网络诊断**: 连接状态监控

## 配置和部署

### 1. 配置文件结构
```python
# 核心配置
name = "配置名称"
description = "配置描述"

# 网络配置
broadcastIP = "广播IP地址"
broadcastPort = 广播端口
periodMS = 周期毫秒

# 从机配置
savedSlaves = [
    {
        SV_name: "从机名称",
        SV_mac: "MAC地址",
        SV_index: 索引,
        SV_fanModel: "风扇型号",
        # ... 更多参数
    }
]

# 风扇阵列配置
fanArray = {
    FA_rows: 行数,
    FA_columns: 列数,
    FA_layers: 层数
}
```

### 2. 网络配置
- **默认端口**:
  - 广播端口: 5005
  - MISO端口: 5006
  - MOSI端口: 5007
  - 监听端口: 5008
- **超时设置**: 可配置的网络超时
- **队列大小**: 各种消息队列的大小限制

### 3. 安全设置
- **通行码**: 网络通信验证
- **套接字限制**: 连接数量限制
- **固件验证**: 更新前的完整性检查

## 故障排除

### 1. 常见问题
- **网络连接失败**: 检查IP地址和端口配置
- **从机无响应**: 验证MAC地址和网络状态
- **固件更新失败**: 检查文件完整性和网络稳定性
- **风扇控制异常**: 验证引脚配置和硬件连接

### 2. 调试步骤
1. 检查网络连接状态
2. 验证配置文件正确性
3. 查看日志输出
4. 测试单个从机连接
5. 验证硬件引脚配置

### 3. 性能优化
- **网络优化**: 调整广播周期和超时设置
- **内存优化**: 监控堆栈使用情况
- **响应优化**: 调整线程优先级和队列大小

## 扩展和定制

### 1. 添加新的风扇型号
1. 在 `Fan.h` 中定义新的引脚配置
2. 更新 `settings.h` 中的最大风扇数
3. 修改配置文件以支持新型号

### 2. 扩展通信协议
1. 在 `standards.py` 中定义新的命令代码
2. 在 `FCCommunicator.py` 中实现处理逻辑
3. 在从机端 `Processor.cpp` 中添加命令处理

### 3. 自定义GUI组件
1. 继承现有的Widget类
2. 实现必要的回调方法
3. 集成到主窗口布局中

## 版本历史

- **Mark IV**: 当前版本，支持以太网通信
- **Mark III**: 前一版本（模块分配差异）
- **Mark II**: 从机端版本标识 "B06271"

## 许可证和贡献

**开发团队**:
- Alejandro A. Stefan Zavala (astefanz@berkeley.edu)
- Chris J. Dougherty (cdougher@caltech.edu)
- Marcel Veismann (mveisman@caltech.edu)

**机构**: 加州理工学院研究生航空实验室自主系统与技术中心

---

*本Wiki文档提供了Fan Club MkIV项目的全面技术概览，涵盖了从系统架构到具体实现的各个方面。如需更详细的信息，请参考相应的源代码文件。*